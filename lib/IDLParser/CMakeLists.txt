add_llvm_library(LLVMIDLParser
  ${CMAKE_CURRENT_BINARY_DIR}/IdiomSpecifications.cpp

  DEPENDS
  idl_parser
  intrinsics_gen
)

set(CMAKE_CXX_STANDARD 14)
add_executable(idl_parser
    Parser.cc
)

ADD_CUSTOM_COMMAND(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/Idioms.idl
                   COMMAND cat ${CMAKE_CURRENT_SOURCE_DIR}/Idioms.idl ${CMAKE_BINARY_DIR}/lilac/Idioms.idl > ${CMAKE_CURRENT_BINARY_DIR}/Idioms.idl
                   DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/Idioms.idl  ${CMAKE_BINARY_DIR}/lilac/Idioms.idl
                   DEPENDS lilac-idl
                   COMMENT "Merge idiom specification files.")

ADD_CUSTOM_COMMAND(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/IdiomSpecifications.cpp
                   COMMAND idl_parser ${CMAKE_CURRENT_SOURCE_DIR}/IDL.bnf ${CMAKE_CURRENT_BINARY_DIR}/Idioms.idl | pypy ${CMAKE_CURRENT_SOURCE_DIR}/stage3.py > ${CMAKE_CURRENT_BINARY_DIR}/IdiomSpecifications.cpp
                   DEPENDS idl_parser  ${CMAKE_CURRENT_SOURCE_DIR}/IDL.bnf ${CMAKE_CURRENT_BINARY_DIR}/Idioms.idl ${CMAKE_CURRENT_SOURCE_DIR}/stage3.py
                   DEPENDS lilac-idl
                   COMMENT "Generate idiom specifications C++ file")
